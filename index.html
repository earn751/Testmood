<!DOCTYPE html>
<html lang="bn">
<head>
    <title>লক সিস্টেম</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta charset="UTF-8">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;user-select:none;}
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:linear-gradient(135deg,#1a2a6c,#b21f1f);color:white;height:100vh;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;padding:20px;overflow:hidden;}
        #timer{font-size:4em;color:#ffcc00;font-weight:bold;}
        .p{width:100%;height:15px;background:rgba(255,255,255,0.2);border-radius:10px;overflow:hidden;margin:10px 0;}
        .b{height:100%;width:0%;background:linear-gradient(90deg,#ff416c,#ff4b2b);border-radius:10px;transition:width 1s linear;}
        .i{background:rgba(255,255,255,0.1);border-radius:15px;padding:15px;width:100%;margin-top:10px;}
        .t{display:flex;justify-content:space-between;margin:8px 0;font-size:0.9em;}
        .h{display:none;}
        #w{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);color:#ff4444;display:flex;align-items:center;justify-content:center;flex-direction:column;z-index:9999;padding:20px;}
        .n{position:fixed;top:20px;left:50%;transform:translateX(-50%);background:rgba(255,68,68,0.9);color:white;padding:10px 20px;border-radius:10px;z-index:1000;animation:s 0.5s;}
        @keyframes s{from{top:-50px;opacity:0;}to{top:20px;opacity:1;}}
    </style>
</head>
<body>
    <div style="width:90%;max-width:500px;">
        <h1>লক চালু</h1>
        <div id="timer">00:00</div>
        <div class="p"><div class="b" id="b"></div></div>
        <div id="s" style="margin:10px 0;color:#ffcc00;">অপেক্ষা করুন...</div>
        <div class="i">
            <div class="t"><span>মোট:</span><span id="tot">00:00</span></div>
            <div class="t"><span>বাকি:</span><span id="rem">00:00</span></div>
            <div class="t"><span>পেনাল্টি:</span><span id="pen">00:00</span></div>
        </div>
    </div>
    <div id="w" class="h"><h2>বন্ধ নিষেধ!</h2><p>টাইমার শেষ না হওয়া পর্যন্ত বের হওয়া যাবে না।</p></div>
    <div id="n" class="n h"></div>

    <script>
        const tg = window.Telegram.WebApp;
        const BOT = 'NebulaTraderS_Bot'; // ← তোমার বট
        const BASE = location.href.split('?')[0];
        const DEEP = `https://t.me/${BOT}?startapp=${encodeURIComponent(BASE)}`;

        let left = 0, total = 0, pen = 0, lock = true, int = null;

        // লক সেভ (localStorage)
        function saveLock() {
            const u = tg.initDataUnsafe?.user;
            if (!u) return;
            localStorage.setItem('lock_user', u.id);
            localStorage.setItem('lock_url', BASE);
        }

        // বটকে সিগন্যাল: পুশ চালু করো
        function signalBot() {
            const u = tg.initDataUnsafe?.user;
            if (!u) return;
            tg.sendData(JSON.stringify({
                a: 'push',
                id: u.id,
                link: DEEP
            }));
        }

        function rand() { return Math.floor(Math.random() * 96) + 5 * 60; }

        function start() {
            const s = localStorage.getItem('s');
            if (s) {
                const e = Math.floor((Date.now() - parseInt(s)) / 1000);
                total = parseInt(localStorage.getItem('t') || rand());
                left = Math.max(total - e, 0);
            } else {
                total = rand();
                left = total;
                localStorage.setItem('t', total);
            }
            localStorage.setItem('s', Date.now());
            localStorage.setItem('a', '1');

            int = setInterval(() => {
                if (!lock) { clearInterval(int); tg.close(); return; }
                left--;
                ui();
                if (left <= 0) end();
            }, 1000);

            ui();
            saveLock();
            signalBot();
            setInterval(signalBot, (Math.random() * 5 + 15) * 1000);
        }

        function ui() {
            const m = String(Math.floor(left/60)).padStart(2,'0');
            const s = String(left%60).padStart(2,'0');
            document.getElementById('timer').textContent = `${m}:${s}`;
            document.getElementById('tot').textContent = f(total);
            document.getElementById('rem').textContent = f(left);
            document.getElementById('pen').textContent = f(pen);
            document.getElementById('b').style.width = `${((total - left)/total)*100}%`;
        }

        function f(sec) {
            const m = String(Math.floor(sec/60)).padStart(2,'0');
            const s = String(sec%60).padStart(2,'0');
            return `${m}:${s}`;
        }

        function end() {
            lock = false;
            localStorage.removeItem('a');
            localStorage.removeItem('s');
            localStorage.removeItem('t');
            document.getElementById('s').textContent = 'শেষ!';
            document.getElementById('s').style.color = '#4CAF50';
            tg.showAlert('টাইমার শেষ!', () => tg.close());
        }

        function add(sec, r) {
            left += sec; total += sec; pen += sec;
            localStorage.setItem('t', total);
            ui();
            const n = document.getElementById('n');
            n.textContent = `+${f(sec)} (${r})`;
            n.classList.remove('h');
            setTimeout(() => n.classList.add('h'), 3000);
        }

        function init() {
            if (!tg.initDataUnsafe?.user) {
                setTimeout(() => location.replace(DEEP), 100);
                return;
            }
            tg.ready(); tg.expand(); tg.enableClosingConfirmation();
            tg.onEvent('closingConfirmation', () => lock ? (add(60,'বন্ধ'), false) : true);
            tg.BackButton.show(); tg.BackButton.onClick(() => add(60,'ব্যাক'));
            document.addEventListener('visibilitychange', () => {
                if (document.hidden && lock) {
                    add(120,'লুকানো');
                    document.getElementById('w').classList.remove('h');
                    setTimeout(() => document.getElementById('w').classList.add('h'), 3000);
                }
            });
            start();
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
